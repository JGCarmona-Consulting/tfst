# devops/azure-pipelines/api/api-cd-dev.yml
# This file contains the pipeline definition for deploying the API to the DEV environment.
trigger:
  branches:
    include:
      - dev
  paths:
    include:
      - src/api/**

pr: none

variables:
  - group: AzureServiceConnectionDev

pool:
  vmImage: ubuntu-24.04

jobs:
  - job: deploy_api
    displayName: "Deploy API to DEV"
    steps:
      # 1. Authenticate and initialize Terraform
      - template: ../templates/terragrunt_init.yml
        parameters:
          subscription: $(SERVICE_CONNECTION_NAME_ARM_DEV)
      
      # 2. Initialize all dependencies
      - bash: |
          echo "Initializing Terragrunt dependencies"
          cd "$(System.DefaultWorkingDirectory)/infrastructure/envs/dev"
          terragrunt run-all init -reconfigure
        displayName: "Initialize Terragrunt Dependencies"
        env:
          ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
          ARM_CLIENT_ID: $(ARM_CLIENT_ID)
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
          ARM_TENANT_ID: $(ARM_TENANT_ID)


      # 3. Fetch App Service Name using template
      - template: ../templates/fetch_app_service_name.yml
        parameters:
          terragrunt_path: infrastructure/envs/dev/app_services/api

      # 4. Build and publish the API
      - task: DotNetCoreCLI@2
        displayName: 'Build .NET Solution'
        inputs:
          command: 'build'
          projects: 'src/api/TheFullStackTeam.Backend.sln'
          arguments: '--configuration Release'
          workingDirectory: '$(System.DefaultWorkingDirectory)/src/api'

      # 5. Deploy API to App Service
      - task: AzureWebApp@1
        displayName: "Deploy API to App Service"
        inputs:
          azureSubscription: $(SERVICE_CONNECTION_NAME_ARM_DEV)
          appType: 'webAppLinux'
          appName: $(APP_SERVICE_NAME)
          package: '$(Build.ArtifactStagingDirectory)'
